{"version":3,"sources":["common/widget-base.js"],"names":[],"mappings":"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","file":"common/widget-base.js","sourceRoot":"/source/","sourcesContent":["import {Util} from './util';\r\nimport {OptionsBuilder} from './options-builder';\r\nimport {TemplateCompiler} from './template-compiler';\r\nimport {TemplateGatherer} from './template-gatherer';\r\nimport {KendoConfigBuilder} from '../config-builder';\r\nimport {inject, transient} from 'aurelia-dependency-injection';\r\nimport {TaskQueue} from 'aurelia-task-queue';\r\nimport * as LogManager from 'aurelia-logging';\r\n\r\nconst logger = LogManager.getLogger('aurelia-kendoui-bridge');\r\n\r\n/**\r\n* Abstraction of commonly used code across wrappers\r\n*/\r\n@transient()\r\n@inject(TaskQueue, TemplateCompiler, OptionsBuilder, Util, TemplateGatherer, KendoConfigBuilder)\r\nexport class WidgetBase {\r\n\r\n  /**\r\n  * The element of the custom element, or the element on which a custom attribute\r\n  * is placed. DOM events will be raised on this element\r\n  */\r\n  element: Element;\r\n\r\n  /**\r\n  * Used to prevent race conditions when events are raised before\r\n  * all bindings have been updated.\r\n  */\r\n  taskQueue: TaskQueue;\r\n\r\n  /**\r\n  * The element on which a Kendo widget is initialized\r\n  * This is the \"element\" by default\r\n  */\r\n  target: Element;\r\n\r\n  /**\r\n  * The Kendo control's name, such as kendoGrid or kendoButton\r\n  */\r\n  controlName: string;\r\n\r\n  /**\r\n  * The parent context (used for template compilation)\r\n  */\r\n  $parent: any;\r\n\r\n  /**\r\n  * The widgets parent viewmodel (this is the object instance the user will bind to)\r\n  */\r\n  viewModel: any;\r\n\r\n\r\n  /**\r\n  * A list of bindings for properties such as kEnable/kReadOnly/kValue\r\n  * whenever one of these properties changes an API function will be called on the Kendo control\r\n  * for example, a change of an 'kEnable' property will result in a .enable(true/false) call\r\n  */\r\n  bindingsToKendo = [];\r\n\r\n  constructor(taskQueue, templateCompiler, optionsBuilder, util, templateGatherer, configBuilder) {\r\n    this.taskQueue = taskQueue;\r\n    this.optionsBuilder = optionsBuilder;\r\n    this.util = util;\r\n    this.configBuilder = configBuilder;\r\n    this.templateGatherer = templateGatherer;\r\n    templateCompiler.initialize();\r\n  }\r\n\r\n  control(controlName) {\r\n    if (!controlName || !kendo.jQuery.fn[controlName]) {\r\n      throw new Error(`The name of control ${controlName} is invalid or not set`);\r\n    }\r\n\r\n    this.controlName = controlName;\r\n\r\n    let ctor = kendo.jQuery.fn[this.controlName];\r\n    this.kendoOptions = ctor.widget.prototype.options;\r\n    this.kendoEvents = ctor.widget.prototype.events;\r\n\r\n    return this;\r\n  }\r\n\r\n  linkViewModel(viewModel) {\r\n    if (!viewModel) {\r\n      throw new Error('viewModel is not set');\r\n    }\r\n\r\n    this.viewModel = viewModel;\r\n\r\n    return this;\r\n  }\r\n\r\n  useViewResources(resources) {\r\n    if (!resources) {\r\n      throw new Error('resources is not set');\r\n    }\r\n\r\n    this.viewResources = resources;\r\n\r\n    return this;\r\n  }\r\n\r\n\r\n  /**\r\n  * adds two-way value binding\r\n  * @param valueBindingProperty the property name of the kendo control (value/checked)\r\n  * @param valueFunction the function on the kendo control that gets the value of the above property\r\n  */\r\n  useValueBinding(valueBindingProperty = 'kValue', valueFunction = 'value') {\r\n    this.valueBindingProperty = valueBindingProperty;\r\n    this.valueFunction = valueFunction;\r\n    this.withValueBinding = true;\r\n\r\n    this.bindToKendo(valueBindingProperty, valueFunction);\r\n\r\n    return this;\r\n  }\r\n\r\n  /**\r\n  * add binding to Kendo\r\n  * whenever a bindable property in a wrapper changes, and the propertyname is in this list\r\n  * then it will call an API function on the Kendo control to update the value\r\n  * @param propertyName the bindable property name in the wrapper (kValue, kChecked, kEnabled)\r\n  * @param valueFunction the API function on the kendo control that sets the value of the above property\r\n  */\r\n  bindToKendo(propertyName, functionName) {\r\n    this.bindingsToKendo.push({\r\n      propertyName: propertyName,\r\n      functionName: functionName\r\n    });\r\n\r\n    return this;\r\n  }\r\n\r\n  /**\r\n  * collects all options objects\r\n  * calls all hooks\r\n  * then initialized the Kendo control as \"widget\"\r\n  */\r\n  createWidget(options) {\r\n    if (!options) {\r\n      throw new Error('the createWidget() function needs to be called with an object');\r\n    }\r\n\r\n    if (!options.element) {\r\n      throw new Error('element is not set');\r\n    }\r\n\r\n    // destroy old widgets\r\n    if (this.viewModel && this.viewModel.kWidget) {\r\n      this.destroy(this.viewModel.kWidget);\r\n    }\r\n\r\n    // generate all options, including event handlers - use the rootElement if specified, otherwise fall back to the element\r\n    // this allows a child element in a custom elements tempate to be the container for the kendo control\r\n    // but allows the plugin to correctly discover attributes on the root element to match against events\r\n    let allOptions = this._getOptions(options.rootElement || options.element);\r\n\r\n    // before initialization callback\r\n    // allows you to modify/add/remove options before the control gets initialized\r\n    if (options.beforeInitialize) {\r\n      options.beforeInitialize(allOptions);\r\n    }\r\n\r\n    // add parent context to options\r\n    // deepExtend in kendo.core will fail with stack\r\n    // overflow if we don't put it in an array :-\\\r\n    Object.assign(allOptions, {\r\n      $angular: [{ _$parent: options.parentCtx, _$resources: this.viewResources }]\r\n    });\r\n\r\n\r\n    if (this.configBuilder.debugMode) {\r\n      logger.debug(`initializing ${this.controlName} with the following config`, allOptions);\r\n    }\r\n\r\n    // instantiate the Kendo control\r\n    let widget = this._createWidget(options.element, allOptions, this.controlName);\r\n\r\n    widget.$angular = [{\r\n      _$parent: options.parentCtx,\r\n      _$resources: this.viewResources\r\n    }];\r\n\r\n    if (this.withValueBinding) {\r\n      widget.first('change', (args) => this._handleValueChange(args.sender));\r\n      widget.first('dataBound', (args) => this._handleValueChange(args.sender));\r\n    }\r\n\r\n    // use Kendo API functions to update all initial values in the wrapper\r\n    // kValue -> .value()\r\n    // kEnabled -> .enable()\r\n    this.bindingsToKendo.forEach(binding => {\r\n      let value = this.viewModel[binding.propertyName];\r\n\r\n      // don't do this when the value of the widget is an empty string\r\n      // as it indicates that the widget has not been databound yet\r\n      if (typeof(value) !== 'undefined' && value !== null && value !== '') {\r\n        widget[binding.functionName](value);\r\n      }\r\n    });\r\n\r\n    if (options.afterInitialize) {\r\n      options.afterInitialize();\r\n    }\r\n\r\n    return widget;\r\n  }\r\n\r\n\r\n  _createWidget(element, options, controlName) {\r\n    return kendo.jQuery(element)[controlName](options).data(controlName);\r\n  }\r\n\r\n\r\n  /**\r\n  * combines all options objects and properties into a single options object\r\n  */\r\n  _getOptions(element) {\r\n    let options = this.optionsBuilder.getOptions(this.viewModel, this.controlName);\r\n    let eventOptions = this.getEventOptions(element);\r\n\r\n    // merge all option objects together\r\n    // - options on the wrapper\r\n    // - options compiled from all the bindable properties\r\n    // - event handler options\r\n    return this.util.pruneOptions(Object.assign({}, this.viewModel.kOptions || {}, options, eventOptions));\r\n  }\r\n\r\n\r\n  /**\r\n  * convert attributes into a list of events a user wants to subscribe to.\r\n  * These events are then subscribed to, which when called\r\n  * calls the fireKendoEvent function to raise a DOM event\r\n  */\r\n  getEventOptions(element) {\r\n    let options = {};\r\n    let allowedEvents = this.kendoEvents;\r\n    let delayedExecution = ['change'];\r\n\r\n    // iterate all attributes on the custom elements\r\n    // and only return the normalized kendo event's (dataBound etc)\r\n    let events = this.util.getEventsFromAttributes(element);\r\n\r\n    events.forEach(event => {\r\n      // throw error if this event is not defined on the Kendo control\r\n      if (!allowedEvents.includes(event)) {\r\n        throw new Error(`${event} is not an event on the ${this.controlName} control`);\r\n      }\r\n\r\n      if (delayedExecution.includes(event)) {\r\n        options[event] = e => {\r\n          this.taskQueue.queueMicroTask(() => this.util.fireKendoEvent(element, this.util._hyphenate(event), e));\r\n        };\r\n      } else {\r\n        options[event] = e => this.util.fireKendoEvent(element, this.util._hyphenate(event), e);\r\n      }\r\n    });\r\n\r\n    return options;\r\n  }\r\n\r\n\r\n  _handleValueChange(widget) {\r\n    this.viewModel[this.valueBindingProperty] = this.getValue(widget);\r\n  }\r\n\r\n  getValue(widget) {\r\n    return widget[this.valueFunction]();\r\n  }\r\n\r\n  handlePropertyChanged(widget, property, newValue, oldValue) {\r\n    let binding = this.bindingsToKendo.find(i => i.propertyName === property);\r\n    if (binding) {\r\n      if (widget && widget[binding.functionName]() !== newValue) {\r\n        widget[binding.functionName](newValue);\r\n      }\r\n    }\r\n  }\r\n\r\n  useTemplates(target, controlName, templates) {\r\n    return this.templateGatherer.useTemplates(target, controlName, templates);\r\n  }\r\n\r\n  /**\r\n  * destroys the widget\r\n  */\r\n  destroy(widget) {\r\n    if (widget) {\r\n      kendo.destroy(widget.element);\r\n      widget = null;\r\n\r\n      if (this.viewModel.kWidget) {\r\n        this.viewModel.kWidget = null;\r\n      }\r\n    }\r\n  }\r\n}\r\n"]}